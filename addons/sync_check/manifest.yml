type: update
name: Health Check Synchronization
id: sync-healthcheck
description:
  text: Health Check Synchronization
  short: Health Check Synchronization
logo: https://raw.githubusercontent.com/jelastic-jps/mysql-cluster/master/addons/recovery/images/database-recovery.png

baseUrl: https://raw.githubusercontent.com/sych74/wordpress-multiregion-standalone/WP-218/addons/sync_check

targetNodes:
  nodeGroup: 
    - cp

mixins:
  - https://raw.githubusercontent.com/jelastic-jps/common/main/clustered-addon-utils.yml

globals:
  app_id: sync_healthcheck
  nodeGroup: cp

buttons:
  - name: diagnostic
    caption: Synchronization Diagnostic
    confirmText: Run synchronization diagnostic?
    loadingText: Diagnostic is in progress...
    action: diagnostic
    
onInstall:
  - checkClustering:
      nodeGroup: ${targetNodes.nodeGroup}
      app_id: ${globals.app_id}
  - installJQTool
  - if (globals.cluster):
    - if (globals.isSecondaryEnv):
      - return:
          type: success
    - else:
      - createFile:
          envName: ${globals.secondaryEnvName}
          nodeGroup: ${targetNodes.nodeGroup}
          app_id: ${globals.app_id}
      - installAddon:
          envName: ${globals.secondaryEnvName}


responses:
  200:
    type: success
    message: Synchronization is OK! No errors have been discovered.
    
  99:
    type: success
    message: |
      Errors were discovered during the synchronization diagnostic.
      Synchronization between clusters does not work.
actions:
  diagnostic:
    - checkClustering:
        nodeGroup: ${targetNodes.nodeGroup}
        app_id: ${globals.app_id}
    - script: /scripts/sych_healthcheck.js
      exec: ' --diagnostic'
      nodeGroup: ${targetNodes.nodeGroup}
      multiregion: true
      envName1: ${globals.primaryEnvName}
      envName2: ${globals.secondaryEnvName}
        
  installAddon:
    install: ${baseUrl}/manifest.yml
    envName: ${this.envName}
    nodeGroup: ${globals.nodeGroup}
    settings:
      user: ${settings.user:}
      password: ${settings.password:}
